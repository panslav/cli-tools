#!/usr/bin/env bash
set -euo pipefail

SESS_DIR="${CODEX_SESSIONS_DIR:-$HOME/.codex/sessions}"
MODE_LATEST=0

if [ "${1:-}" = "--latest" ]; then
  MODE_LATEST=1
  shift
fi

FILTER="${1:-}"

if [ ! -d "$SESS_DIR" ]; then
  echo "Session directory not found: $SESS_DIR" >&2
  exit 1
fi

format_label() {
  file="$1"
  base="$(basename "$file" .jsonl)"
  label="$(printf '%s\n' "$base" | sed -E "s/^rollout-([0-9]{4}-[0-9]{2}-[0-9]{2})T([0-9]{2})-([0-9]{2})-([0-9]{2}).*$/\1 \2:\3:\4/")"
  if [ "$label" = "$base" ]; then
    date_part="$(printf '%s\n' "$file" | sed -nE 's#^.*/([0-9]{4})/([0-9]{2})/([0-9]{2})/.*$#\1-\2-\3#p')"
    if [ -n "$date_part" ]; then
      label="$date_part 00:00:00"
    fi
  fi
  printf '%s\n' "$label"
}

extract_session_id() {
  file="$1"
  id="$(sed -nE 's/.*"type":"session_meta".*"id":"([^"]+)".*/\1/p' "$file" | head -n 1)"
  if [ -z "$id" ]; then
    id="$(sed -nE 's/.*"id":"([^"]+)".*/\1/p' "$file" | head -n 1)"
  fi
  printf '%s\n' "$id"
}

FILES=()
while IFS= read -r file; do
  FILES+=("$file")
done < <(find "$SESS_DIR" -type f -name '*.jsonl' | sort -r)

if [ -n "$FILTER" ]; then
  FILTER_LC="$(printf '%s' "$FILTER" | tr '[:upper:]' '[:lower:]')"
  FILTERED=()
  for file in "${FILES[@]}"; do
    if printf '%s' "$file" | tr '[:upper:]' '[:lower:]' | grep -Fq "$FILTER_LC"; then
      FILTERED+=("$file")
    fi
  done
  FILES=("${FILTERED[@]}")
fi

if [ "${#FILES[@]}" -eq 0 ]; then
  echo "No matching sessions found." >&2
  exit 1
fi

LABELS=()
for file in "${FILES[@]}"; do
  LABELS+=("$(format_label "$file")")
done

if [ "$MODE_LATEST" -eq 1 ] && [ -z "$FILTER" ]; then
  exec codex resume --last
fi

if command -v fzf >/dev/null 2>&1 && [ -t 0 ] && [ -t 1 ]; then
  OPTIONS=()
  i=0
  while [ "$i" -lt "${#FILES[@]}" ]; do
    OPTIONS+=("${LABELS[$i]}	${FILES[$i]}")
    i=$((i + 1))
  done
  CHOICE="$(printf '%s\n' "${OPTIONS[@]}" | fzf --prompt='codex session> ' --height=40% --reverse --delimiter=$'\t' --with-nth=1)"
  [ -n "$CHOICE" ] || exit 0
  CHOICE="${CHOICE#*$'\t'}"
else
  i=1
  for label in "${LABELS[@]}"; do
    printf '%2d) %s\n' "$i" "$label"
    i=$((i + 1))
  done
  printf 'Select session number: '
  read -r idx
  case "$idx" in
    ''|*[!0-9]*)
      echo "Invalid number." >&2
      exit 1
      ;;
  esac
  if [ "$idx" -lt 1 ] || [ "$idx" -gt "${#FILES[@]}" ]; then
    echo "Selection out of range." >&2
    exit 1
  fi
  CHOICE="${FILES[$((idx - 1))]}"
fi

SESSION_ID="$(extract_session_id "$CHOICE")"
if [ -z "$SESSION_ID" ]; then
  echo "Could not extract session id from: $CHOICE" >&2
  exit 1
fi

exec codex resume "$SESSION_ID"
